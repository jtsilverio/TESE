---
bibliography: references.bib
---

# Annual changes in activity patterns of the Anillaco tuco-tuco (_Ctenomys sp._)

```{r setup, include=FALSE}
library(coppedown)
library(knitr)
library(ggplot2)
library(patchwork)
library(data.table)
library(dplyr)
library(momentuHMM)
library(maptools)
library(showtext)
library(scales)
library(grid)
library(lubridate)
library(activity)

# Set Global Chunk Options
knitr::opts_chunk$set(
    fig.align = "center",
    echo = FALSE, 
    message = FALSE,
    warning = FALSE
    )


# Read Data --------------------------------------------------------------------
tuco = readRDS("../01_data/activity_processed/tuco_processed.rds")
tuco.metadata = fread("../01_data/animals/animal_metadata.csv")
source("../03_analysis/actogram/function_actogram.R")


# Decode HMM state -------------------------------------------------------------
# Read Models 
m1 = readRDS("../03_analysis/hmm/m1.rds")  # modelo vazio
m2 = readRDS("../03_analysis/hmm/m2.rds") # modelo com 

# Viterbi State Decoding
decoded = viterbi(m2)
tuco$state = factor(decoded, labels = c("Low","Medium","High"))

# # Widen State Column, so its a little bit easier to index by state.
# tuco = tuco %>% 
#     mutate(rest = ifelse(state == "Rest", T, F),
#            medium = ifelse(state == "Medium", T, F),
#            high = ifelse(state == "High", T, F))


# Calculate Sunrise and Sunset Times -------------------------------------------
anillaco = matrix(c(-66.95, -28.8), nrow = 1) 
sunriset = tuco %>% dplyr::select(ID, season, datetime) %>%
  group_by(ID, season) %>% 
  summarise(datetime = median(datetime))

sunriset$dawn = maptools::crepuscule(crds = anillaco,
                                    dateTime = sunriset$datetime,
                                    solarDep = 6, 
                                    direction = "dawn", 
                                    POSIXct.out=TRUE)$day_frac  * 1440

sunriset$dusk = maptools::crepuscule(crds = anillaco,
                                    dateTime = sunriset$datetime,
                                    solarDep = 6,
                                    direction = "dusk",
                                    POSIXct.out=TRUE)$day_frac  * 1440

sunriset_season = sunriset %>%
  group_by(season) %>% 
  summarise(dawn = median(dawn), dusk = median(dusk), daytime_length = dusk - dawn)

# calculate daylength ----------------------------------------------------------
anillaco = matrix(c(-66.95, -28.8), nrow = 1) 
daylength = tuco[, .(datetime = median(datetime)), by = ID]

daylength$dawn = maptools::crepuscule(crds = anillaco,
                    dateTime = daylength$datetime,
                    solarDep = 6,
                    direction = "dawn",
                    POSIXct.out=TRUE)$day_frac  * 1440

daylength$dusk = maptools::crepuscule(crds = anillaco,
                                    dateTime = daylength$datetime,
                                    solarDep = 6,
                                    direction = "dusk",
                                    POSIXct.out=TRUE)$day_frac  * 1440

daylength = daylength[, .(daylength = dusk - dawn), by = ID]
tuco = left_join(tuco, daylength, by = "ID")

# Set Theme ----------------------------------------------------------
font_add_google("Roboto Condensed", "roboto")
showtext_auto()

tuco_pal = c("Low" = "#66C2A5",
             "Medium" = "#5a69af",
             "High" = "#c25b67",
             "General Activity" = "#393939")

theme_tuco =
    egg::theme_article() +
    theme(text = element_text(size = 14,
                              family = "roboto")
          )

theme_set(theme_tuco)
```

```{r for-review-only, include=FALSE}
# Set LaTeX tables styling
if(knitr::is_latex_output()){
  library(kableExtra)
  kable = function(data, caption = NULL, scale = F){
    
    if(scale == F){
        knitr::kable(data,
                     booktabs = TRUE,
                     digits = 3,
                     align = "c",
                     caption = caption) %>% 
        kable_styling(position = "center", 
                      latex_options = c("hold_position")
                )
    }else{
               knitr::kable(data,
                     booktabs = TRUE,
                     digits = 3,
                     align = "c",
                     caption = caption) %>% 
        kable_styling(position = "center", 
                      latex_options = c("hold_position", "scale_down")
                ) 
    }
  }
}else{
    library("magick")
    library("webshot")
    library(flextable)
    kable = function(data, caption = "NULL", scale = F){
      flextable::flextable(data) %>% 
        flextable::set_caption(caption) %>% 
        colformat_double(digits = 2) %>% 
        plot(zoom = 2, expand = 10)
    }
}
```


## Introduction

Many environmental factors, such as light, have cyclic 24-hour variations, in the form of day-night cycles. These cyclic environmental changes can impose time-dependent restrictions and trade-offs on an animal's physiology and behavior. Animals have evolved an internal timekeeping system to cope with these daily environmental changes, which involves the circadian clock. The circadian clock generates a variety of physiological, metabolic, and behavioral daily rhythms — such as hormonal rhythms, body temperature rhythms, and activity rhythms (**REF**). Rhythms driven by the circadian clock, and thus generated endogenously, are referred to as circadian rhythms (i.e. circa 24-hour). One main characteristic of the circadian clock is that it is synchronized by daily environment cycles, acting as an internal timekeeper and maintaining a stable temporal relationship between the internal physiology and the external environmental cycle. The presence of circadian clocks is thought to enable organisms to anticipate daily environmental challenges [@Jabbur2021; @pittendrigh1993], so changes in physiology and behavior occur in anticipation of predictable environmental changes. The reactive response to environmental factors, not driven by the circadian clock, is also important in shaping activity rhythms. Animals are constantly interacting with multiple environmental cycles or non-cyclic challenges and, not surprisingly, can also respond acutely to these external stimuli, by activity inhibition or stimulation. In nocturnal mammals, for example, light has both effects, the light-dark cycle synchronizes  the circadian clock and can also acutely inhibit the animals' activity. Consequently, in nature, the observed daily rhythm, such as the activity rhythm, is an outcome of the interaction of these two mechanisms: the synchronized circadian clock, driving endogenous rhythms, and the direct response to environmental stimulus.
 
Circadian clock and biological rhythms studies have been majorly conducted in laboratory conditions, which is a powerful approach that enabled the characterization of the clock and its mechanism of synchronization. Studies on circadian rhythms relied heavily on manipulating the light-dark cycle and controlling for other variables to investigate synchronization. However, there are limitations to laboratory approaches, especially when we want to extrapolate what we learned in the laboratory to an ecological context [@enright1970; @halle2000; @helm2017]. In nature, animals are exposed to multiple cyclic and non-cyclic environmental challenges, including biotic factors such as predation, competition, social interaction and food availability; and abiotic factors such as temperature, humidity and light. Consequently, the observed daily rhythm in nature has significantly more influence from direct responses to external stimuli than in the laboratory [@hut2012; @kronfeld-schor2003]. For example, interspecific competition between _Dypomys microps_ and _Dypomys merriami_ appears to drive activity of _D. merriami_ to the last part of the night [@kenagy1973]. A more extreme case is exhibited by the golden spiny mouse, _Acomys russatus_, where it completely changes its activity pattern from nocturnal to diurnal in areas where the common spiny mouse, _Acomys cahirinus_, is absent [@kronfeld-schor2003; @shkolnik1971]. A second aspect that hinders the understanding of the significance of circadian rhythms in nature is that the behavior and physiology of laboratory animals might be unrepresentative of those of wild animals [@calisi2009]. A growing number of rodents have completely different activity patterns between laboratory and nature, with some species exhibiting nocturnal running wheel activity when in the laboratory but field observations reveal diurnal activity in nature [@hut2012]. There are also cases where the same animal transferred from field to the laboratory completely changes its activity pattern, as is also the case for _Acomys russatus_. The reasons for this dramatic change in activity patterns is still unknown, but it is hypothesized that changes to a more diurnal activity pattern might have energetic advantages, helping reduce thermoregulatory costs [@hut2012]. There has also been a lot of effort in advancing the studies of chronobiology in the wild to better understand the ecology and adaptive significance of circadian rhythms [@dominoni2017; @helm2017; @kronfeld-schor2013]. Overall, these examples illustrate that it is hard to translate some aspects of chronobiology from the lab to the wild and that more field studies are still needed to better disentangle the influences and relevance of the endogenous clock and the direct responses to external stimulus in natural conditions.

Daily activity rhythms studies require a continuous recording of individual activity for a prolonged time, thus it renders studies in the wild a practical and technological challenge [@silverio2020]. Recording individual fine-scale activity data on some species of animals is hard, especially because some species are difficult to capture, observe or record for long time periods. More recently, however, advancements and miniaturization of animal-borne sensors allowed researchers to investigate fine-scale activity and physiology in free-living animals [@rutz2009; @wilmers2015]. These sensors, also known as _biologgers_, have enabled the remote fine-scale measurements of animal activity with relatively low disturbance. Two kinds of biologgers widely used in ecological and, more recently, in chronobiological studies are lightloggers and accelerometers. Lightloggers, as the names imply, record the light exposure of animals; they are often used in migration studies when the timing of light exposure is of importance. Accelerometers, in turn, are devices that record animal movement in three dimensions, which can be used to calculate and quantify general activity, energy expenditure and estimate movement paths [@brown2013]. Albeit fine-scale time series data from biologgers is  ecologically rucher, it also requires more complex methods and techniques to be analyzed [@brown2013]. One analytical tool used to deal with such type of data is the Hidden Markov Models (HMM)., which can be used, for example, to model the dynamics between rest and active states [@mcclintock2020]. All in all, the possibility of recording individual fine-scale data and the recent statistical methods available opens a lot of opportunities to study activity rhythms in free-living animals.

The Anillaco tuco-tuco (_Ctenomys_ aff _knightii_) is an example of rodent species that has been studied in laboratory and semi-natural enclosures, and exhibit distinct activity patterns between these conditions. The genus _Ctenomys_ is endemic to South America, distributed in diverse habitats, from  deserts to high altitudes [@freitas2021]. Species from this genus are subterranean and spend most of their time inside their tunnels, going out of their tunnels to forage and maintain their tunnel systems [@freitas2021]. The Anillaco tuco-tuco occurs around the village of Anillaco, in the province of La Rioja, a semi arid region in the north west of Argentina.In the laboratory, standard chronobiological experiments showed that their running wheel activity rhythm is driven by the circadian clock and synchronized by the light-dark cycle [@tachinardi2014; @valentinuzzi2009]. In these controlled settings tuco-tucos are nocturnal, running in the wheel almost exclusively during the night [@valentinuzzi2009]. In semi-natural enclosures, however, visual observations and automated recordings of light exposure and activity shows that the Anillaco tuco-tuco emerges to the surface during the day [@jannetti2019; @flores2016; @tomotani2012], and hence it is characterized as diurnal, opposed to what is recorded in the laboratory. In semi-natural enclosures it has also been shown that surface emergence is correlated with environmental temperature, changing seasonally. In winter tuco-tucos generally go out of their tunnels during the middle of the day, in the hottest hours [@jannetti2019], while in the summer the hottest hours are avoided and surface emergence occurs mainly in the beginning and end of the day [@flores2021]. Although laboratory and semi-natural enclosures have been crucial to understand the chronobiology and activity patterns of tuco-tucos, they do not replicate the whole complexity of natural habitats. Using available _biologgers_ we can now record activity and surface emergence simultaneously in free-living tuco-tucos, which might shed light into the range of biotic and abiotic factors shaping tuco-tucos activity patterns in their complex natural habitat and validate the  recorded activity patterns in semi-natural enclosures.

In the present work our first aim is to develop a field methodology to study free-living tuco-tucos using _biologgers_. Our second aim is to describe the daily activity and surface emergence patterns in free-living Anillaco tuco-tucos using _biologgers_, additionally describing the annual changes in such patterns. To do this we deployed animal-borne accelerometers and light loggers on 21 Anillaco tuco-tucos in different months of the year during 2019 and 2020, Activity data was analysed using the Vectorial Dynamic Body Acceleration (VeDBA) and  hidden Markov models to classify and describe the annual changes between possible different behavioral states.

## Methods

### Study Species

The studied *Ctenomys* population lacks a formal phylogenetic and taxonomic classification but there are some lines of evidence suggesting that the study area is occupied by a single unidentified species [@amaya2016]. In other studies, the studied *Ctenomys'* species has been referred informally as the Anillaco tuco-tuco [@amaya2016] and as *Ctenomys* aff. *knightii* [@tomotani2012] or *Ctenomys* cf. *knightii* [@valentinuzzi2009].

### Study Site

Field work was conducted at a site located approximately 5km away from the village of Anillaco, in the province of La Rioja, Northwest Argentina. The study site (-66.95°, -028.80, 1325m, approximately 75m²; Figure \@ref(fig:methods-map)) is located within the Monte Desert biome and surrounded by the Velasco mountain range. This area has little human disturbance and no artificial light source. The Monte Desert is characterized as an open shrubland dominated by Zygophyllaceae (*Larrea cuneifolia* Cav., *Tricomaria usillo*), Fabaceae (*Prosopis torquata*, *Senna aphylla*) and Cactaceae (*Trichocereus* spp, *Tephrocactus* spp) [@abraham2009; @fracchia2011; @aranda-rickert2011a]. At the study site a non-extensive survey of the plant community divided in three transects showed a dominance of the families Zygophyllaceae (*Larrea cuneifolia*, *Tricomaria usillo*), Poaceae (*Microchloa indica*, *Aristida mendocina*) and Fabaceae (*Zuccagnia punctata*) (Appendix, Figure \@ref(fig:appendix-plants)). The climate is arid with marked daily and seasonal cycles in temperature and rainfall (Appendix, Figure \@ref(fig:appendix-weather)). The monthly mean temperature ranges from 12°C in the winter months to 23°C in the summer months, with a clear difference in the daily temperature range [@abraham2009]. The mean annual rainfall ranges from 145 to 380mm concentrated almost exclusively in the summer months [@fracchia2011].

```{r methods-map, echo=F, out.width = "100%", fig.cap="Study site location (orange polygon) at the Monte Desert, approximately 5km away from the village of Anillaco, northwest of Argentina. Study site has an area of approximately 75 m². Geographical information retrieved from ESRI satellites (Datum SIRGAS 2002 UTM 19s)."}

include_graphics("../04_figures/map/tuco_map.png")
```

### Animal Capture and Handling

A total of 30 tuco-tucos were part of the present study and received _biologging_ collars. Trapping was conducted in four different campaigns to the study site. Three campaigns were done in 2019 during March-April (Autumn), July (Winter) and October (Spring). A fourth campaign was done in February 2020 (Summer). A fifth campaign was planned to occur in May 2020 but had to be canceled due to the COVID-19 outbreak. Tuco-tucos were captured using a custom-made PVC pipe trap (35cm length, 10cm diameter) with a spring-loaded aluminum door at one end and a PVC-lid at the other. Before setting the traps, the study site was scouted for active tuco-tuco's burrows. Active burrows could be identified by the presence of freshly excavated soil mounds at the burrow's entrance. Once found, burrows were excavated to open the access to the underground tunnels and a trap was placed horizontally at the burrow's entrance following the tunnel's orientation. Traps were placed at all active burrows found at the study site, limited to a max of 20 traps available. Traps were set in the field during the morning and checked every 2 hours, when they were reset if they had been plugged with soil or if they had been activated without any tuco-tuco capture. Traps were checked for a last time at dusk and then taken out if no animal had been caught.

After capture, adult tuco-tucos (>120g) were lightly anesthetized in order to be carefully examined and receive a biologging collar. We used a clear plastic anesthesia chamber (318.5cm³) with a clip-on lid and a cotton ball affixed inside of the chamber, out of the animal's reach. The cotton ball received approximately 0.5 mL of isoflurane before transferring the animal from the trap to the chamber. While in the chamber animals were observed for breathing, blinking and loss of righting reflex. Once the tuco-tucos could not right themselves they were removed from the chamber. Anesthetized animals were weighted (CSseries, OHAUS, ± 1 g precision), sexed, assessed for reproductive status, marked with a subcutaneous identification PITTag (Passive Integrative Transponder. Allflex, Brasil) and fitted with a collar bearing biologgers (See Biologgers).

Animals were released in the same burrow they were originally captured. They were left in the field for 5-18 days before being recaptured for collar recovery. All animal captures, procedures and animal handling were authorized by the local authorities at *Dirección General de Ambiente y Desarrollo Sustentable -- Secretaría de Ambiente del Ministerio de Producción y Desarollo Local* -- La Rioja, Argentina (#00501-17). All procedures were also approved by the Ethics Committee at the *Instituto de Biociências* (#308-2018) and *Faculdade de Medicina Veterinária* (#2045300519) of the *Universidade de São Paulo*.

### Biologgers

Accelerometers (Axy-4, TechnoSmart, Italy) and lightloggers (W65, Migrate Technology, UK) were used to record general motor activity and light exposure, respectively. These biologgers were attached to a collar made of a cable tie inserted through silicon tubing [@jannetti2019; @williams2014; Figure \@ref(fig:methods-collar)]. A telemetry transmitter (SOM-2011. Wildlife Materials, USA) was also attached to the collar to assist in animal location during recapture and minimize sensor's loss. The complete collar setup (accelerometer, lightlogger and telemetry) weighted approximately 6g. Collars without the lightlogger weighted 5.3g. All accelerometers recorded tri-axial acceleration at a 10Hz sampling frequency and 4G sensitivity. Lightloggers were set to sample illuminance every minute but only recorded the maximum sampled value each 5 minutes. The lighlogger recording range was 1-19000 lux.

```{r methods-collar, echo=F, out.width = "100%", fig.cap="Collar setup and example of field deployment. Upper photo shows the complete collar setup with accelerometer, lightlogger and the telemetry transmitter. Bottom photo shows a tuco-tuco wearing a collar. In the bottom photo it is possible to see the acceleromer and the lightlogger attached to the collar."}

include_graphics("../04_figures/collar/collar_tuco.png")
```

### Data Processing

Data were recorded on board of the sensors and later downloaded and converted to raw text files using softwares provided by the manufacturers. Acceleration data was used to measure gross motor activity. Tri-axial acceleration data was first reduced to one dimension using the Vectorial Dynamic Body Acceleration (VeDBA, [@qasem2012]). VeDBA, measured in gravitational g, is commonly used as a proxy for the animal’s activity level and energy expenditure [@williams2016]. VeDBA was calculated by: (i) Estimating the effect of the gravitational force over the accelerometer, also known as static acceleration. The static acceleration can be estimated by applying a moving average over the raw acceleration data. There is not a consensus over the number of points used to calculate the moving average, which can be dependent on the study species and device's recording frequency. In this study we used a 4-second moving average after following the methodology proposed by @shepard2008, Figure \@ref(fig:appendix-smooth-window)]. (ii) Calculating the dynamic acceleration corresponding to the animal’s movement in each axis. The dynamic acceleration was calculated by subtracting the static acceleration from the raw data. (iii) Lastly, we calculate the VeDBA by the vectorial sum of the dynamic acceleration over the device's axes (1.1). Once VeDBA was calculated, the 1Hz acceleration data was downsampled by taking the median over a 1-minute non-overlapping sliding window. 

\begin{equation}
VeDBA = \sqrt{X^2 + Y^2 + Z^2} (\#eq:vedba)
\end{equation}

Light exposure was used to analyse patterns of surface emergence, the time tuco-tucos spend on the surface and to further classify VeDBA data points as above or below ground. We classified each 5-minutes data point as being above or below ground using a 2 lux threshold [@jannetti2019].

Accelerometer and lightlogger data were merged accordingly to the date and times of recordings using purposely written R scripts [@rcoreteam2020]. Because time of recordings between both devices were not synchronized to the minute lightlogger recording times was rounded to the nearest 5 minutes to merge both data streams.

All animal's data points were classified as occurring during the daytime or nighttime based on the daylength of the recording dates. Daylength was calculated with the _maptools_ package in R [@bivand2020], which uses the National Oceanic and Atmospheric Administration (NOAA) equations for estimating twilight times. We used civil twilight times, defined as the times in which the center of the sun is 6° below the horizon, as thresholds to calculate daylength and classify datapoints as occurring during the day or nighttime. Annual daylength variation at the study site can be seen in the Appendix (Figure \@ref(fig:appendix-daylength)).

To exclude any effects that capture and recapture can have on the animal's activity, we removed the first and last days of all datasets. We also excluded the data corresponding to the days we were attempting to recapture the animal in cases where the recapture attempts took longer than one day. Animals that had data excluded due to recapturing efforts were FEV05 (5 days), JUL16 (5 days) and JUL23 (2 days).

### Surface Emergence & Time On Surface 

Visualization of the daily temporal pattern of surface emergence was done using the 5-minute aboveground data (see Data Processing). Data points classified as aboveground were treated as presence/absence and used to visualize the temporal pattern of surface emergence by Von Mises circular kernel density estimates as proposed by [@rowcliffe2014], a method generally used in camera trap studies. These visualizations were done at the population level, using the pooled data from all animals of a given month of the year. The individual surface emergence patterns are also provided in the appendix. It is important to note that the area under the kernel density estimates sums to 1 and shows the relative probability of surface emergence, it does not reflect the absolute amplitude of the rhythm.

To  analyze tuco-tuco’s surface emergence we calculated the mean time on surface per animal and the percentage of time on surface relative to daytime. Time on surface was calculated presuming that each 5-minute data point classified as aboveground was spent entirely outside the animal's burrow. Accordingly, we deduced the daily time on surface by first summing the number of daily above ground data points multiplied by 5 minutes, and then calculating the mean daily time on surface per animal. In the same manner we also calculated the percentage of the daytime spent on the surface per day and then, calculated the mean percentage per animal.

### General Activity

General activity was analyzed using the calculated VeDBA (see Data Processing). The general activity temporal patterns were visually analyzed by calculating the hourly mean VeDBA, which was calculated by binning the VeDBA data into 1-hour intervals for each animal and then calculating the mean for each time interval.

VeDBA were analyzed in relation to the daily mean VeDBA and the percentage of VeDBA during the daytime. This  was done by (1) grouping the data per animal and summing the total VeDBA of each day and (2) for each animal taking the mean of the calculated total VeDBA per day. The mean percentage of VeDBA during the daytime was calculated in the same manner by dividing the daily sum of VeDBA during the daytime by the total sum of VeDBA and then calculating the mean per animal.

### Behavioral State Classification

#### Hidden Markov Models

We used Hidden Markov Models (HMMs) to further analyze and classify the 1-minute VeDBA data. HMMs are a type of time series model, therefore, they take into account the temporal dependency of the observations [@leosbarajas2017]. HMMs are also well suited to model accelerometer data given their intrinsic temporal dependency [@leosbarajas2017; @patterson2019].

HMMs are composed of two time series: the observable *state-dependent process* ($X_t$), VeDBA in our case, and an underlying, or hidden, *state process* ($S_t$). The *state process* is what drives the observations and what we are interested in estimating, which roughly corresponds to behavioral states.

The *state process* follows the Markov Property and take temporal dependency into account [@zucchini2016]. The Markov property denotes that a state $S_t$ depends only on the previous state $S_{t-1}$ [@zucchini2016]. In the case of accelerometer and animal movement studies the states are representations of the animals' behavior and can take on finite number ($N$) of possible values. The number of states can be chosen *a priori* or based on model selection [@pohle2017]. The changes in probabilities between states are also part of the of HMM formulation, summarized by a Transition Probability Matrix that gives the probability of transitioning from the current state to a possible future state.

In the basic HMM formulation the observable *state-dependent process* comes from a mixture of $N$ distributions, one for each state. These distributions come from a common distribution family (e.g. Normal, Weibull or Gamma) and each one have their own set of parameter values. The active distribution is determined by the state of the system at a given time $t$. Therefore, the observations are a realization from one of these distributions. The distribution parameters, state transition probabilities and other model parameters can be estimated by numerical maximization of the Likelihood [@zucchini2016]. With the model parameters in hand, the most probable state sequence can be found by the Viterbi algorithm [@mcclintock2020; @zucchini2016].

<!-- ```{tikz, hmm-formulation, fig.cap = "Basic dependence structure for a Hidden Markov Model", fig.ext = "pdf", fig.width = 4, fig.height = 4, fig.align = 'center', echo = FALSE} -->
<!--   \usetikzlibrary{automata,positioning} -->
<!--   \begin{tikzpicture} -->
<!--   \tikzstyle{main}=[circle, minimum size = 5mm, thick, draw =black!80, node distance = 10mm] -->
<!--   \tikzstyle{connect}=[-latex, thick] -->
<!--   \tikzstyle{box}=[rectangle, draw=black!100] -->
<!--     \node[box,draw=white!100] (Observed) {\textbf{Observed}}; -->
<!--     \node[main] (X1) [right=of Observed] {$X_1$}; -->
<!--     \node[main] (X2) [right=of X1] {$X_2$}; -->
<!--     \node[main] (X3) [right=of X2] {$X_3$}; -->
<!--     \node[main] (Xt) [right=of X3] {$X_t$}; -->
<!--     \node[box,draw=white!100] (Latent) [below=of Observed] {\textbf{Hidden}}; -->
<!--     \node[main,fill=black!10] (S1) [right=of Observed,below=of X1] {$S_1$}; -->
<!--     \node[main,fill=black!10] (S2) [right=of X1,below=of X2] {$S_2$}; -->
<!--     \node[main,fill=black!10] (S3) [right=of X2,below=of X3] {$S_3$}; -->
<!--     \node[main,fill=black!10] (St) [right=of X3,below=of Xt] {$S_t$}; -->
<!--     \path (X3) -- node[auto=false]{\ldots} (Xt); -->
<!--     \path (S1) edge [connect] (S2) -->
<!--           (S2) edge [connect] (S3) -->
<!--           (S3) -- node[auto=false]{\ldots} (St); -->
<!--     \path (S1) edge [connect] (X1); -->
<!--     \path (S2) edge [connect] (X2); -->
<!--     \path (S3) edge [connect] (X3); -->
<!--     \path (St) edge [connect] (Xt); -->
<!--     \draw[dashed]  [below=of S1,above=of X1]; -->
<!--   \end{tikzpicture} -->
<!-- ``` -->

#### Model Formulation and State Classification

In our models we have chosen VeDBA as our activity metric. We determined *a priori* a possible number of three different states ($N=3$). This decision was made based on our research question, in the VeDBA distributions (REF Figure \@ref(fig:appendix-eda)) and in the biological interpretability of the states. We labelled the states as roughly corresponding to low, medium and high intensity activity.

HMMs can be fitted individually [e.g. @vandekerk2015] or to a pool of animals [@langrock2012]. The models can also include covariate effects that modify either the *state-dependent* distribution parameters or the transition probabilities [@patterson2009; @langrock2012]. We fitted a 3-state HMM to the 1-minute VeDBA data using a 'complete pooling' approach. This means that the *state-dependent* distribution parameters are common to all animals. Therefore, we assume that individuals are independent and behaviors are the same to all individuals and across the year. However, given that the season/month of the year seems to be an important feature influencing the VeDBA distribution (Figure \@ref(fig:appendix-eda)) we included season as a covariate in the *state process*. Hence, we let the probability of changing from one state to another vary in relation to the season/month of the year. We also fitted an empty model, with no covariate effects, and used Akaike's Information Criteria (AIC) to select the model with best fit to the data.

Models were fitted using the momentuHMM package in R [@mcclintock2021]. We used the gamma distribution, parametrized with mean and standard deviation, to model VeDBA. The gamma distribution is a flexible distribution, that accommodates positive right-skewed data. Appropriate starting values for likelihood maximization of model's parameters were found by following procedures suggested by @michelot2019. Season was included as a categorical variable, its influence over the transition probabilities was summarized using stationary probabilities plots [@leosbarajas2017]. The most probable state sequence was decoded using the Viterbi algorithm [@zucchini2016]. We checked model assumptions and goodness of fit by visual inspection of the pseudo-residuals [@zucchini2016]. The decoded sequence was then used to conduct other _post-hoc_ analysis of time spent in each state, aboveground activity, diurnality and rhythmicity. 

### Daily Time-Activity Budgets & Behavioral States Patterns

We used the labeled behavioral state data to visually analyze how the behaviors are organized in time. We visualize the temporal patterns in behavioral states using the same methods we used in the surface emergence patterns. The temporal pattern in each behavioral state was visualized by using a Von Mises circular kernel density estimate [@rowcliffe2014]. The kernel density estimate was done at the population level, using the pooled data from all animal of each month of the year. The individual behavioral state patterns are also provided in the appendix.

To analyze tuco-tuco's behavioral states we also calculated their mean daily time and the mean daily proportion in each behavioral state (i.e time-activity budget). Similar to what was done in the general activity we summarized and reduced the VeDBA data to one point estimate per animal. The mean daily time in a state was calculated by first grouping the data per animal and calculating the daily time spent in each state by summing the labeled data points of each state. Since the data has 1-minute intervals we take that the number of labeled points per day corresponds to the time spent in each behavioral state. Then, we calculated the mean daily time in state per animal by taking the mean of the previously calculated daily time in state. We also calculated the time-activity budget per animal in the same manner, except we divided the time spent in each state by 1440 minutes.

### Aboveground Activity

We calculated the prevalence of each behavioral state when animal's were aboveground, outside of their tunnels. Aboveground activity was defined as any activity in which animals were exposed to light with intensity greater than 2 lux (see Data Processing). Using the combined state-labelled and light logger data we calculated the total time spent in each state in the surface and the percentage relative to the total time spent aboveground. Similar to the procedures used in the general activity analysis we also calculated only one point estimate per animal. The mean time spent in each state was calculated by first summing the time spent in each state per day and then taking the mean per animal. The percentage of time spent in each state was calculated in the same manner by calculating the percentage of time spent in each state in relation to the total time aboveground and then taking the mean of these percentages per animal.

### Diurnality Index

We defined diurnality index (DI) as the percentage of daytime the animals spent in one of the states relative to the total time spent in the same state during both daytime and night-time, corrected by the daylength of each season [@halle2000 and @jannetti2019]. The DI ranges from 0 to 1, with 0 meaning that all activity happens during the night and 1 meaning the opposite, that all activity happens during the day.

Diurnality calculation is shown in equation \@ref(eq:diurnality), where $ts_{day}$ and $ts_{night}$ are the time spent in the state during the day and night respectively. $L_{day}$ and $L_{night}$ are the day length and night length, determined by the civil twilight, calculated using the _maptools_ package in R [@bivand2020].

\begin{equation}
Diurnality = \frac{ts_{day}/L_{day}}{ts_{day}/L_{day} + ts_{night}/L_{night}} (\#eq:diurnality)
\end{equation}

### Circadian Rhythmicity and Period Estimation

We used autocorrelation analysis [@levine2002; @dowse2009] and Lomb-Scargle periodograms to assess the robustness and periodicity of activity rhythms. The autocorelation was calculated by comparing the data to itself lagged by a unit of time. The autocorrelation coefficient ranges from 0 to 1 and it is higher as both time series are more similar to each other. When visually analyzing the autocorrelation plot, recurring peaks indicates that the data is periodic. The height of the peak shows how robust the rhythms is [@dowse2009]. The robustness of the rhythm, also referred as the Rhythmicity Index (RI), is defined as the autocorrelation coefficient at the third peak of the autocorrelation plot (i.e. the height of the third peak).

Before estimating the RI, we applied a 3-hour low-pass Butterworth filter to remove periodicity lower than 3 hours in the data. Autocorrelation plots were first visually analyzed and labeled as rhythmic if they showed recurring peaks in the 24-hour range. Animals that showed no recurring peaks were classified as arrhythmic in the circadian range. Next, we estimated the period of each behavioral state, for animals that were classified as rhythmic, using the Lomb-Scargle periodogram [@leise2017]. For comparison with the labeled data, we also calculated the RI for the unlabeled VeDBA data

All analysis were done in R [@rcoreteam2020]. Butterworth filtering was done using the the *dlpR* package [@bunn2008]. Autocorrelation function and plots were done in base R. The peaks in the autocorrelation plots were found using the *pracma* package [@hansw.borchers2019]. Lomb-Scargle periodograms were calculated using the *lomb* package [@ruf1999].

### Statistical tests

We used ANOVA and post-hoc Tukey’s HSD to test for differences between month-groups in time on surface, general activity levels, time spent on behavioral states, time spent on aboveground activity and diurnality. Rhythmicity was compared only between behavioral states, we did not perform a month-group comparison given that, as some animals were classified as arrhythmic, the sample number for each season was too low to perform a meaningful statistical analysis. We checked for normality before conducting the ANOVA tests by visual plots and with Shapiro Wilk test.

We also visually compared daily patterns of general activity levels, time on surface and behavioral states based on the temporal distributions along the 24-hours. The daily temporal distribution on all cases, except for the general activity level (see General Activity Level), were visualized using Von Mises circular kernel density estimates. All analysis were done in R using the base packages (R Core Team 2020). 

\newpage

## Results

We captured and deployed collars to 20 females and 10 males, 13 collars had both sensors. We were able to recapture 24 tuco-tucos and recover 21 collars (Table \@ref(tab:table-captures)), a total of 70% of success rate in collar recovery. One collar was found malfunctioning because one animal got predated. The other two lost collars fell or were taken out of the tuco-tuco's neck between the time of capture and recapture. A complete list of number of recorded days per animal can be seen in the Appendix \@ref(tab:animals-table-appendix).

```{r calculate-captures, include=FALSE}
# Since the tables have nested columns I couldn't generate them using R and opt to generated in LaTeX.
# The code to calculate the sums are the following:
tuco.metadata %>%
          group_by(Month = season) %>%
          summarise("Captured" = length(ID),
                    "Recaptured" = sum(recaptured),
                    "Collar Recovered" = sum(collar_recovered))
          #bind_rows(colSums(.[2:4]))

tuco.metadata %>%
          group_by(Month = season) %>%
          summarise(Females = sum(sex == "f" & collar_recovered),
                    Males = sum(sex == "m" & collar_recovered),
                    Accelerometers = sum(acc & collar_recovered),
                    Lightloggers = sum(lux & collar_recovered))
```

```{=latex}
\begin{table}[h]
\centering
\caption{Number of captured animals and sensors deployed in the field. There was a higher number of females captured independent of the season. Recapture rates in March 2021 are lower because field work had to be interrupted due to the covid outbreak. Not all recaptured tucos still had their collars. Some collar were taken out by the animals between the time of captured and recaptured. One tuco was predated and the collar was found 1km away from the initial capture burrow malfunctioning.}
\label{tab:table-captures}
\resizebox{\textwidth}{!}{%
\begin{tabular}{llllllll} 
\toprule
         & \multicolumn{2}{c}{Captured}                            & \multicolumn{2}{c}{Recaptured}                          &                                       &                                    &                                   \\ 
\cmidrule{2-5}
    & \multicolumn{1}{c}{Males} & \multicolumn{1}{c}{Females} & \multicolumn{1}{c}{Males} & \multicolumn{1}{c}{Females} & \multicolumn{1}{c}{Recovered Collars} & \multicolumn{1}{c}{Accelerometers} & \multicolumn{1}{c}{Lightloggers}  \\ 
\midrule
February & 3                         & 7                           & 2                         & 5                           & 5                                     & 5                                  & 5                                 \\
July     & 4                         & 5                           & 4                         & 5                           & 8                                     & 8                                  & 6                                 \\
March    & 0                         & 2                           & 0                         & 2                           & 2                                     & 2                                  & 0                                 \\
October  & 3                         & 6                           & 1                         & 5                           & 6                                     & 6                                  & 2                                 \\
\bottomrule
\end{tabular}
}
\end{table}
```

### Time On Surface

```{r}
# Calculate Above ground activity
tuco_luximeter = tuco.metadata %>% filter(lux, recaptured, collar_recovered) %>% dplyr::select(ID)    

# calculate percentage of daylenght seen per animal
time_aboveground = tuco %>% 
    filter(ID %in% tuco_luximeter$ID) %>% 
    group_by(ID, season, date = lubridate::date(datetime)) %>% 
	summarise(daylength = sum(daytime),
	          time_aboveground = sum(aboveground, na.rm = T) * 5,
	          perc_aboveground = time_aboveground/daylength) %>% 
    group_by(ID, season) %>% 
    summarise(mean_t_aboveground = mean(time_aboveground),
              sd_t_aboveground = sd(time_aboveground),
              mean_p_aboveground = mean(perc_aboveground),
              sd_p_aboveground = sd(perc_aboveground),
              daylength = median(daylength)) %>% 
    ungroup()
```

Surface emergence shows a changing daily temporal pattern along the year. In July, the peak of surface emergence is concentrated in the middle of the day. In other seasons the peak of surface emergence shifts to the the first hours of daylight (Fig. \@ref(fig:plot-light-exposure)A). 

The total time on surface shows no difference along the year. The overall mean and standard deviation of daily time on surface was `r time_aboveground %>% summarise(mean = mean(mean_t_aboveground), sd = sd(mean_t_aboveground)) %>% summarise(mean = paste0(round(mean,2)," ± ", round(sd, 2)))`, with no significant differences among month groups (ANOVA, F = 2.148, p = 0.167). In contrast, the daily percentage of the time on surface relative to day length was significantly different between groups (ANOVA; F = 4.38, p = 0.0429). Post hoc Tukey’s HSD shows a significant difference between July-February (p = 0.035). For these groups the mean daily percentage of time on surface is `r time_aboveground %>% filter(season == "July") %>% summarise(mean = mean(mean_p_aboveground), sd = sd(mean_p_aboveground)) %>% summarise(mean = paste0(scales::percent(round(mean,2)), " ± ", scales::percent(round(sd, 2))))` for July, and `r time_aboveground %>% filter(season == "February") %>% summarise(mean = mean(mean_p_aboveground), sd = sd(mean_p_aboveground)) %>% summarise(mean = paste0(scales::percent(round(mean,2)), " ± ", scales::percent(round(sd, 2))))` for February.\newline

```{r daily-lux-density, fig.pos = "H",fig.asp=0.6, fig.width=9, out.width="100%"}
# Auxiliar function to extract data from the object returned by the activity::fitact as a data.frame
# Daily VeDBA Patterns ----------------------------------
tuco_hourly = tuco %>%
    filter(ID %in% tuco_luximeter$ID) %>%
    mutate(time = floor_date(datetime,
                             unit = "hour")) %>%
    mutate(time = lubridate::hour(time)*60+lubridate::minute(time)) %>% 
    group_by(ID, season, time, date = date(datetime)) %>% 
    summarize(sum = sum(aboveground, na.rm = T)) %>% 
    group_by(ID, season, time) %>% 
    summarise(sum = mean(sum))

tuco_hourly_mean = tuco_hourly %>%
    group_by(season, time) %>% 
    summarize(mean = mean(sum)) %>% 
    ungroup()

light_patterns = ggplot(data = tuco_hourly_mean,
           aes(x = time,y = mean)) +
    geom_line(data = tuco_hourly,
              aes(x = time, y = sum, fill = ID),
              size = 0.4,
              alpha = 0.1) +
    geom_point(size = 0.9, color = "orange") +
    geom_line(size = 0.9, color = "orange") +
    geom_vline(data = sunriset_season,
               aes(xintercept = dawn), 
               linetype = "dotted",
               color = "grey70") +
    geom_vline(data = sunriset_season,
               aes(xintercept = dusk),
               linetype = "dotted",
               color = "grey70") +
    scale_x_continuous(breaks = c(0,360,720,1080,1440),
                       labels = c(0,6,12,18,24))+
    facet_wrap(~season, ncol = 2) +
    theme(legend.position = "none") +
    xlab("Time (h)") +
    ylab("Mean number of\nsurface emergences")
```

```{r plot-aboveground}
# Plots ---------------------------------------------------------
graph_t_aboveground = ggplot(data = time_aboveground, aes(x = season, y = mean_t_aboveground)) +
    gghalves::geom_half_point(color = "orange") +
    gghalves::geom_half_boxplot(nudge = 0.05, outlier.alpha = 0, color = "orange") +
	xlab("") +
	ylab("Mean daily\ntime on surface (min)")

graph_p_aboveground = ggplot(data = time_aboveground, aes(x = season, y = mean_p_aboveground)) +
    gghalves::geom_half_point(color = "orange") +
    gghalves::geom_half_boxplot(nudge = 0.05, outlier.alpha = 0, color = "orange") +
	xlab("") +
	ylab("Mean time on surface\nrelative to daylength (%)") +
    scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                       breaks = c(0, 0.05, 0.1, 0.15, 0.20, 0.25),
                       limits = c(0, 0.25))

df1 = data.frame(x = c("February", "July"), y = c(0.21,0.21))
graph_p_aboveground = graph_p_aboveground +
   geom_line(data = df1, mapping = aes(x,y, group = 1), color = "grey60") +
   annotate("text", x = "October", y = 0.22, label = "*", size = 4, color = "grey60")
```

```{r plot-light-exposure, fig.pos="H",fig.height=7, fig.width= 8, out.width="100%", fig.cap="Tuco-tuco’s daily patterns of surface emergence and average time on surface. (A) Daily temporal pattern of surface emergence. X-axis is time of the day in Anillaco, La Rioja (UTC-3). Dotted vertical lines show times of civil twilights. (B) Mean daily time on surface per animal. Each point is an animal’s mean daily time on surface (ANOVA; p = 0.167). (C) Mean daily percentage of time on surface in relation to the daylength. Each point is an animal’s mean daily percentage of time on surface (ANOVA; p = 0.043). Asterisks indicates pairwise significant statistical difference (Tukey’s HSD; p < 0.05)."}
 light_patterns / (graph_t_aboveground + graph_p_aboveground) + 
#light_patterns / (graph_t_aboveground) +
    plot_annotation(tag_levels = "A") + 
    plot_layout(heights = c(1.8,1))
```

\clearpage

### General Activity

Tuco-tuco's general activity follows a typical diurnal pattern. Hourly mean VeDBA is lower during the night time, rises just before dawn, remains generally higher during the daytime and falls just after dusk. The average daily VeDBA is significantly different among month-groups (ANOVA; F = 7.182, p = 0.002; \@ref(fig:vedba-boxplot)). There is a significant month-group difference between July-October and July-February (Tukey’s HSD, p < 0.05). In both pairwise comparisons July's average daily VeDBA is lower, with a difference in means of 0.029 g in comparison to October and 0.019 g in comparison to February. 

The percentage of daytime VeDBA is also significantly different between months (ANOVA; F = 8.288, p = 0.001; \@ref(fig:vedba-boxplot)). There significant difference between July-October and July-February (Tukey's HSD, p < 0.05), with a lower July VeDBA level and mean difference of 13%.\newline

```{r vedba-boxplot, fig.width=9, fig.asp = 0.8, out.width="100%", fig.pos="H", fig.cap="Tuco-tuco's daily temporal pattern of VeDBA and Mean daily VeDBA. (A) Daily temporal pattern of VeDBA binned by hour. Light gray horizontal lines show individual patterns, where each line is representative of an animal. Black lines show hourly mean VeDBA of all pooled animals in the respective month. (B) Mean daily VeDBA. Each point is an animal’s Mean daily VeDBA. There is a significant difference between month-groups (ANOVA, p = 0.002). In July tuco-tucos exhibited lower average daily VeDBA than October and February (Tukey’s HSD; Jul-Oct = 0.002, Jul-Feb = 0.049). (C) Percentage of VeDBA that occurs during daytime. Points show mean daytime percentage of VeDBA in relation to the total VeDBA during the day.  There is a significant group difference (ANOVA; p = 0.013). In July animal’s show lower VeDBA during the day than October and February (Tukey’s HSD; Jul-Oct = 0.001, Jul-Feb = 0.006). Vertical dotted lines show time of civil twilights."}

# Daily VeDBA Patterns ----------------------------------
tuco_hourly = tuco %>%
    mutate(time = floor_date(datetime,
                             unit = "hour")) %>%
    mutate(time = lubridate::hour(time)*60+lubridate::minute(time)) %>% 
    group_by(ID, season, time, date = date(datetime)) %>% 
    summarize(vedba = sum(vedba)) %>% 
    group_by(ID, season, time) %>% 
    summarize(mean_vedba = mean(vedba)) %>% 
    ungroup()

tuco_hourly_mean = tuco_hourly %>%
    group_by(season, time) %>% 
    summarize(mean_vedba = mean(mean_vedba)) %>% 
    ungroup()

vedba_hourly = 
    ggplot(data = tuco_hourly_mean,
           aes(x = time,y = mean_vedba)) +
    geom_line(data = tuco_hourly,
              aes(x = time, y = mean_vedba, fill = ID),
              size = 0.4,
              alpha = 0.1) +
    geom_point(size = 0.9) +
    geom_line(size = 0.9) +
    geom_vline(data = sunriset_season,
               aes(xintercept = dawn), 
               linetype = "dotted",
               color = "grey70") +
    geom_vline(data = sunriset_season,
               aes(xintercept = dusk),
               linetype = "dotted",
               color = "grey70") +
    # geom_text(data = data.frame(x = 65, y = 0.29),
    #           aes(x,y, label = c("n = 2","n = 8","n = 6","n = 5")),
    #           size = 3,
    #           color = "grey60") +
    scale_x_continuous(breaks = c(0,360,720,1080,1440),
                       labels = c(0,6,12,18,24))+
    facet_wrap(~season, ncol = 2) +
    theme(legend.position = "none") +
    xlab("") +
    ylab("Hourly mean VeDBA (g)")

# BOXPLOT 01 -----------------------------------
vedba_daily = tuco %>% 
    group_by(ID, season, date = lubridate::date(datetime)) %>% 
    summarise(vedba = sum(vedba)) %>% 
    group_by(ID, season) %>% 
    summarise(vedba = mean(vedba))

bx_daily_vedba = ggplot(data = vedba_daily,
                       aes(x = season,
                           y = vedba)) +
    gghalves::geom_half_point() +
    gghalves::geom_half_boxplot(nudge = 0.05,
                              outlier.color = NA) +
    scale_x_discrete(labels = c("Mar","Jul","Oct","Feb")) +
    xlab("Time (h)") +
    ylab("Mean daily VeDBA (g)") +
    theme(legend.position = "none")

df1 = data.frame(x = c(1.9, 3), y = c(230,230))
df2 = data.frame(x = c(1.9, 4), y = c(240, 240))

bx_daily_vedba = bx_daily_vedba +
   geom_line(data = df1, mapping = aes(x,y, group = 1), color = "grey60") +
   annotate("text", x = 2.5, y = 232, label = "*", size = 4, color = "grey60") +
   geom_line(data = df2, mapping = aes(x,y, group = 1), color = "grey60") +
   annotate("text", x = 3, y = 242, label = "*", size = 4, color = "grey60")


# BOXPLOT 02 -----------------------------------
vedba_daytime = tuco %>%
    group_by(ID, season, date = lubridate::date(datetime)) %>% 
    summarise(vedba = sum(vedba[daytime])/sum(vedba)) %>% 
    group_by(ID, season) %>% 
    summarise(vedba = mean(vedba))

bx_daytime_vedba = ggplot(data = vedba_daytime,
                       aes(x = season,
                           y = vedba)) +
    gghalves::geom_half_point() +
    gghalves::geom_half_boxplot(nudge = 0.05,
                              outlier.color = NA) +
    scale_x_discrete(labels = c("Mar","Jul","Oct","Feb")) +
    scale_y_continuous(breaks = seq(0.5, 1, 0.1), labels = scales::percent, limits = c(0.5, 0.85)) +
    xlab("") +
    ylab("Mean percentage of daytime VeDBA relative to total daily VeDBA") +
    theme(legend.position = "none")


df1 = data.frame(x = c(1.9, 3), y = c(0.8,0.8))
df2 = data.frame(x = c(1.9, 4), y = c(0.825, 0.825))
bx_daytime_vedba = bx_daytime_vedba +
   geom_line(data = df1, mapping = aes(x,y, group = 1), color = "grey60") +
   annotate("text", x = 2.5, y = 0.809, label = "*", size = 4, color = "grey60") +
   geom_line(data = df2, mapping = aes(x,y, group = 1), color = "grey60") +
   annotate("text", x = 3, y = 0.835, label = "*", size = 4, color = "grey60")


# Compose Plot
vedba_hourly / (bx_daily_vedba + bx_daytime_vedba) +
    plot_annotation(tag_levels = "A") +
    plot_layout(ncol = 1, height = c(2,1))
```

### Behavioral State Classification

We fitted two different HMMs to VeDBA data, one empty model, with no covariates, and a second one with *'season'* as a covariate in the transition probability matrix. The second model was selected based on informational criterion ($\Delta$AIC > 2; REF Tabela AIC nos supps).

The estimated state-dependent distributions are shown in Figure \@ref(fig:hmm-plot). We interpreted and labelled these states as low, medium and high intensity activity. The marginal distribution (Figure \@ref(fig:hmm-plot); dashed line) has a good correspondence to the empirical VeDBA distribution. A visual analysis of the Pseudo-residuals (Figure \@ref(fig:appendix-residuals)) shows that the residuals deviate from the expected normal distribution, especially in the lower end values, and that there is still significant residual autocorrelation. Nevertheless, the overall fitting seems to be reasonable. The estimated state-dependent parameters are shown in the Appendix (Table \@ref(tab:appendix-parameters)). \newline

```{r hmm-plot, echo=FALSE, fig.asp=0.5, fig.width=9, out.width="100%",warning=FALSE, fig.pos = "H", fig.cap="State-dependent distributions of the selected Hidden Markov model fitted to the VeDBA acceleration metric. Histogram, in grey, shows the empirical VeDBA from the pooled data of 21 Anillaco's tuco-tuco. State-dependent gamma distributions are shown above the histograms. These distributions are weighted accordingly to the proportion of observations assigned to each state."}

params = list()
params[["mean"]] = unname(m2$mle$vedba[1,])
params[["sd"]] = unname(m2$mle$vedba[2,])
params[["weight"]] = as.numeric(momentuHMM::timeInStates(m2)[1,])

# Plot Histogram + density curves. Gamma density curves are weighted by
# the time spent in each viterbi state sequence. 
# This is is accordance with what is done in the momentuHMM:::plot. I just wanted to plot things in ggplot2.

for(i in 0:3){
    x = seq(from = 0, to = round(max(tuco$vedba),2), length.out = 1000)
    d = data.frame(
        mapply(
            function(rate, shape, weight){
                dgamma(x, rate, shape) * weight
            },
            rate   = (params$mean/params$sd)^2,
            shape  = params$mean/(params$sd^2),
            weight = params$weight))
    
    if(i == 3){
        d = data.frame(d)
        names(d) = c("Low","Medium","High")
        d$Marginal = d$Low + d$Medium + d$High
        d$x = x
        d = tidyr::pivot_longer(d, 1:4, names_to = "state", values_to = "density")
    }
}

ggplot(tuco, aes(x = vedba)) +
    geom_histogram(data = tuco, 
                   aes(x = vedba, y = ..density..), 
                   alpha = 0.2, 
                   binwidth = 0.015, 
                   color = "white") +
    scale_colour_manual(name = "States", values = c(tuco_pal[1:3], Marginal = "grey40")) +
    #theme_article() +
    xlab("VeDBA (g)") +
    ylab("Density") +
    geom_line(data = d[d$state != "Marginal",], aes(x = x, y = density, color = state), size = 1.2) +
    geom_line(data = d[d$state == "Marginal",], aes(x = x, y = density, color = state), size = 0.5, linetype = "dashed")
```

With the state-labeled data we were able to dissociate and visualize the daily patterns of each different state. An example of how VeDBA levels and the behavioral states are related is shown in Figure \@ref(fig:actograms-results). 

A visual inspection of all individual actograms (Appendix Figure \@ref(fig:vedba-actograms)) indicates that the high activity state rhythm is more robust than the Medium Activity rhythm. Nonetheless, neither of these behavioral states occurs exclusively during the daytime. The high activity state, despite being more concentrated during the daylight hours, also occurs sporadically during the night. Medium Activity, in turn, is spread throughout the day and night. 

```{r}
# Do Running Length Decoding to get Start and End of Activity/Sleep
act_rle = tuco %>%
    group_by(ID) %>%
    summarise(status = rle(as.vector(state))$values,
              length = rle(as.vector(state))$lengths) %>%
    ungroup() %>% 
    mutate(end = cumsum(length),
           start = end - length + 1)

act_rle = act_rle %>% 
    group_by(ID) %>% 
    summarise(
        status = status,
        start = start,
        end = end,
        start_datetime = (tuco$datetime[start]),
        end_datetime = (tuco$datetime[end]))

# For plotting segments that cross the boundary between days we need to split
# these segments into two smaller segments, one for each day. 
across_index = which(as_date(act_rle$start_datetime) != as_date(act_rle$end_datetime),)

first_segment = 
    act_rle[across_index,] %>% 
    mutate(old_end_datetime = end_datetime,
           end_datetime = as_datetime(paste0(as_date(start_datetime), "23:59:59"),
                                      tz = "America/Argentina/La_Rioja"),
           old_end_datetime = NULL)

second_segment = 
    act_rle[across_index,] %>% 
    mutate(old_start_datetime = start_datetime,
           start_datetime = as_datetime(paste0(as_date(end_datetime), "00:00:00"),
                                        tz = "America/Argentina/La_Rioja"),
           old_start_datetime = NULL)

# Join new segments into previous dataframe
# Create new columns splitting date and time
act_rle = act_rle[-across_index,] %>% 
    rbind(first_segment) %>%
    rbind(second_segment) %>%
    group_by(ID) %>%
    mutate(start_date = lubridate::as_date(start_datetime),
           end_date = lubridate::as_date(end_datetime),
           start_time = lubridate::hour(start_datetime) * 60 + lubridate::minute(start_datetime),
           end_time =  lubridate::hour(end_datetime) * 60 + lubridate::minute(end_datetime),
           day_number = data.table::frank(start_date, ties.method = "dense")
    ) %>% 
    ungroup()


actograms_medium = act_rle %>%
    filter(ID == "OCT09" & status == "Medium" & day_number <= 5) %>% 
    ggplot() +
    geom_vline(data = sunriset %>% filter(ID == "OCT09"), 
               aes(xintercept = dawn), color = "grey60", linetype = 2, size = 0.5) +
    geom_vline(data = sunriset %>% filter(ID == "OCT09"),
               aes(xintercept = dusk),  color = "grey60", linetype = 2, size = 0.5) +
    geom_linerange(aes(y = day_number,
                       xmin = start_time,
                       xmax = end_time,
                       color = status),
                   size = 7) +

    scale_y_continuous(trans = "reverse", breaks = 1:5, expand = c(0.1, 0.1)) +
    scale_x_continuous(breaks = c(0, 360, 720, 1080, 1440), 
                       labels = c(0, 6, 12, 18, 24)) +
    scale_color_manual(values = tuco_pal) +
    #facet_wrap(vars(ID), ncol = 4) +
    theme(legend.position = "none") +
    ggtitle("Medium Activity") +
    xlab("Time (h)") +
    ylab("")

actograms_high = act_rle %>%
    filter(ID == "OCT09" & status == "High" & day_number <= 5) %>% 
    ggplot() +
    geom_vline(data = sunriset %>% filter(ID == "OCT09"), 
               aes(xintercept = dawn), color = "grey60", linetype = 2, size = 0.5) +
    geom_vline(data = sunriset %>% filter(ID == "OCT09"),
               aes(xintercept = dusk),  color = "grey60", linetype = 2, size = 0.5) +
    geom_linerange(aes(y = day_number,
                       xmin = start_time,
                       xmax = end_time,
                       color = status),
                   size = 7) +
    scale_y_continuous(trans = "reverse", breaks = 1:5, expand = c(0.1, 0.1)) +
    scale_x_continuous(breaks = c(0, 360, 720, 1080, 1440), 
                       labels = c(0, 6, 12, 18, 24)) +
    scale_color_manual(values = tuco_pal) +
    #facet_wrap(vars(ID), ncol = 4) +
    theme(legend.position = "none") +
    ggtitle("High Activity") +
    xlab("Time (h)") +
    ylab("")
```

```{r actograms-results, fig.pos = "H", out.width = "100%", fig.width = 8, fig.height=4.5 ,fig.cap = "Actograms and time series plots of general activity, measured by VeDBA, and state-labelled data of a representative animal (\\#OCT09). The actograms show daily patterns of VeDBA (A) and of Medium and High State occurrences (B and C) classified using HMM. Medium Activity State shows no clear pattern of a daily rhythm, with episodes spread throughout the day. High Activity, on the other hand, has a higher concentration during daylight hours. The time series (D) shows 1-minute VeDBA measures colored by behavioral state. Dashed lines show time of dawn and dusk."}
# Select one tuco
tuco_selected = tuco %>% filter(ID == "OCT09")
remove_facet = theme(strip.text.x = element_blank(),
                     plot.title = element_text(size=12))

# General Activity Actogram --------------------------------------------------------------------
actograms_vedba = plot_actogram(tuco_selected, plot_days = 5) + 
    remove_facet +
    ggtitle("General Activity") +
    xlab("Time (h)")

# Time Series ------------------------------------------------------------------
tuco_selected = tuco_selected[day_number <= 5]   
# ts_vedba = ggplot(tuco_selected) +
#     geom_point(aes(datetime, vedba, color = state), size = 0.3) + 
#     xlab("") +
#     ylab("VeDBA (g)") +
#     scale_x_datetime(date_breaks = "12 hours") +
#     scale_color_manual(values = tuco_pal[1:3], labels = c("Rest", "Medium", "High")) +
#     labs(color = "State") +
#     guides(colour = guide_legend(override.aes = list(size=1.5)))


ts_vedba_zoom = ggplot(tuco_selected) +
    geom_point(aes(datetime, vedba, color = state), size = 0.3) + 
    xlab("") +
    ylab("VeDBA (g)") +
    scale_x_datetime(date_breaks = "1 day") +
    scale_color_manual(values = tuco_pal[1:3], labels = c("Low", "Medium", "High")) +
    labs(color = "State") +
    guides(colour = guide_legend(override.aes = list(size=1.5))) +
    ggforce::facet_zoom(xy = day_number == 2, zoom.size = 1, show.area = F, horizontal = FALSE) +
    theme_bw()


# Organize Plot ----------------------------------------------------------------
design = "
1123344
5555555
5555555
5555555
"

actogram_results = actograms_vedba +
                    wrap_elements(grid::textGrob(" ⇒",
                                  gp = gpar(fontsize=35, col="#2F4F4F", 
                                            fontfamily = "Sans")), 
                                            ignore_tag = T) +
                    actograms_medium + 
                    actograms_high +
                    wrap_elements(ts_vedba_zoom) +                 
                    plot_layout(design = design, heights = c(3, 1.8)) + 
                    plot_annotation(tag_levels = 'A') +
                    theme(plot.tag.position = c(0, 1),
                          plot.tag = element_text(hjust = 0, vjust = 0))

actogram_results
```

\clearpage

### Daily Behavioral States Patterns

Daily activity patterns for each behavioral state are shown in Figure \@ref(fig:plot-patterns). These plots show that, qualitatively, the timing of occurrence of High Activity episodes follow a diurnal pattern. Medium Activity, in contrast, is spread out along the 24h and do not follow a daily (24-hour) rhythm. It is important to note that the timing of peak occurrence of High Activity behavior does not appear to change dramatically along the year, in all the sampled Months the peak of High Activity is around 14:00.

\newpage

```{r plot-patterns, fig.height = 9, fig.width=10, out.width="95%", fig.cap="Density estimates of daily activity patterns of tuco-tucos’ behavioral states. Solid lines indicate the Von-Mises circular kernel density estimates. Light-colored bars show observed distribution of each behavioral state occurrence. The x-axis is hour of the day in Anillaco, La Rioja (UTC-3). Dotted vertical lines show time of civil twilights. Visually, the low activity state is not exclusive of one phase of the day, occurring both during day and night, although, more concentrated during the night. Medium activity visually shows no clear daily rhythms, with medium activity occurring during day and night. High activity state shows a clear diurnal pattern independent of the time of the year, peaking at around 14:00. "}

get_pdf = function(x){
    m = fitact(x$radians, adj = 0.3)
    data = data.frame(m@data)
    pdf  = data.frame(m@pdf)
    return(list(data, pdf))
}

tuco_fit = tuco %>% 
    dplyr::select(ID, sex, season, time, state) %>% 
    mutate(radians = time * ((2*pi)/1440)) %>% 
    tidyr::nest(cols = -c(season, state)) %>% 
    mutate(fit = purrr::map(cols, get_pdf)) %>% 
    dplyr::select(-cols)

kernel_data = tuco_fit %>% 
    mutate(data = purrr::map(fit, function(x) x[[1]])) %>% 
    select(-fit) %>% 
    tidyr::unnest(data)

kernel_pdf = tuco_fit %>% 
    mutate(pdf = purrr::map(fit, function(x) x[[2]])) %>% 
    select(-fit) %>% 
    tidyr::unnest(pdf)
    
patterns_state = ggplot() +
    geom_histogram(data = kernel_data,
                   aes(x = m.data,
                           y = ..density..,
                           fill = state),
                   color = "white",
                   alpha = 0.2,
                   bins = 24) +
    #geom_ribbon(aes(x, ymin = lcl, ymax = ucl), fill = "grey70") +
    geom_density(data = kernel_pdf,
                 aes(x, y, color = state),
                 stat = "identity",
                 size = 0.8) +
    scale_x_continuous(limits = c(0, 2*pi),
                       breaks = c(0, pi/3, 2*pi/3, pi, 4*pi/3, 5*pi/3, 2*pi),
                       labels = c(0, 4, 8, 12, 16, 20, 24)) +
    facet_grid(season~state) +
    scale_color_manual(values = tuco_pal) +
    scale_fill_manual(values = tuco_pal) +
    theme(legend.position = "none")+
    xlab("Time (h)") +
    ylab("Density") +
    geom_vline(data = sunriset_season,
               aes(xintercept = dawn * ((2*pi)/1440)), 
               linetype = "dotted",
               color = "grey70") +
    geom_vline(data = sunriset_season,
               aes(xintercept = dusk * ((2*pi)/1440)),
               linetype = "dotted",
               color = "grey70") 
patterns_state
```

\clearpage

### Diurnality

High Activity State is predominately diurnal (DI \> 0.5). The average diurnality for the High Activity State is higher than 0.7 for all seasons. The Medium Activity State, however, has a diurnality index that ranges from 0.5 in March to 0.56 in July and February. The low activity state is predominantly nocturnal with Diurnality lower than 0.38 in all seasons. There is no statistical difference between seasons (ANOVA; p \> 0.05 for all states; Figure \@ref(fig:diurnality-plot)). \newline

```{r calculate-diurnality}
diurnality_vedba = tuco %>% 
    group_by(ID, season, daylength, daytime) %>%
    summarise(vedba_sum = sum(vedba)) %>% 
    group_by(ID, season) %>% 
    summarise(diurnality = (vedba_sum[daytime]/daylength)/
                           (vedba_sum[daytime]/daylength + vedba_sum[!daytime]/(1440 - daylength)) ) %>% 
    unique()
diurnality_vedba$state = "General Activity"

    
diurnality = tuco %>% 
    group_by(ID, date(datetime), season) %>% 
    mutate(daylength = sum(daytime)) %>% 
    group_by(ID, date(datetime), season, state) %>% 
    summarise(daylength = median(daylength),
              nighttime = sum(!daytime),
              daytime = sum(daytime),
              diurnality = (daytime/daylength)/
                  (daytime/daylength + nighttime/(1440 - daylength))) %>% 
    group_by(ID, season, state) %>% 
    summarise(diurnality = mean(diurnality))

diurnality = dplyr::full_join(diurnality, diurnality_vedba)
diurnality$state = factor(diurnality$state, levels = c("Low","Medium","High","General Activity"))
```

```{r diurnality-plot, fig.pos = "H", out.width="100%", fig.width=8, fig.asp=0.4, fig.cap = "Distribution of calculated diurnality index (DI). Each point represents the DI of an animal. High Activity State is predominantly diurnal, with diurnality greater than 0.7 across all month-groups. General activity, measured by the unlabelled VeDBA, is also predominantly diurnal. Medium state is spread almost evenly between day and night. Low activity is concentated during the night."}

ggplot(diurnality,
      aes(x = season,
          y = diurnality,
          color = state)) +
    geom_hline(yintercept = 0.5, linetype = "dashed", color = "grey90") +
    gghalves::geom_half_boxplot(nudge = 0.05,
                                outlier.color = NA) +
    gghalves::geom_half_point() +
    scale_color_manual(values = tuco_pal) +
    scale_x_discrete(labels = c("Mar","Jul","Oct","Feb")) +
    scale_y_continuous(limits = c(0,1))+
    facet_wrap(~state, ncol = 4) +
    xlab("") +
    ylab("Diurnality Index (DI)") +
    theme(legend.position = "none")
```
\newpage

### Daily Time-Activity Budgets

On average, tuco-tucos spent 680 ± 67 minutes per day in the low activity state, with no statistical difference between seasons (ANOVA; F = 1.93, p = 0.163).

In contrast, there is a significant difference in the percentage of time spent in Medium and High Activity States (Medium: ANOVA, F = 4.457, p = 0.0175; High: ANOVA, F = 13.62, p = < 0.001). In the medium state there is a significant difference between July-October (Tukey's HSD, p < 0.05). The mean time spent in the medium state in July was 491 ± 89.3 minutes and in October  357 ± 61.2 minutes. The high activity states show a significant difference between October-July and February-July (Tukey's HSD, p < 0.01). The daily mean time spent in high activity was: July, 227 ± 43.7 minutes; October, 424 ± 82 minutes; February 355 ± 52.2 minutes.

```{r calculate-time-state}
daily_budget_id = tuco %>% 
    group_by(season, ID, date = lubridate::date(datetime), state) %>%
    summarise(
        time = n(),
        perc = n()/1440 
    ) %>% 
    group_by(ID, season, state) %>% 
    summarise(
        time = mean(time),
        perc = mean(perc)
    )
```

```{r plot-activity-budget, fig.asp=1, fig.width=9, out.width="100%", fig.cap = "Time spent in each behavioral state and corresponding individual time-activity budgets. (A) Time-activity budget of the allocation of behavioral states per animal. (B) Mean daily time in each behavioral state per animal. Asterisks show statistical significance in pairwise comparison between Months. The mean percentage of time spent in the Medium Activity State, however, is higher in July in comparison with October (Tukeys’s HSD, p < 0.05). The mean percentage of time spent in the High Activity State is lower in July in comparison to October and February (Tukeys’s HSD, p < 0.05)."}

daily_budget_id$ID = paste0("#", daily_budget_id$ID)

bar_time = ggplot(daily_budget_id, aes(perc, ID, fill = state, group = season)) +
              geom_bar(position = "stack",
                       stat = "identity") +
              geom_text(aes(label = round(perc, 3) * 100), 
                        position = position_stack(vjust = 0.5), 
                        color = "grey98", size = 2.8) +
              scale_fill_manual(values = tuco_pal[1:3]) +
              #scale_x_continuous(expand = c(0.02, 0)) +
              facet_grid(season~.,
                         scales = "free",
                         space = "free_y") +
              xlab("Mean percentage of the day in state") +
              ylab("") +
              theme(panel.border = element_rect(colour = NA, fill=NA),
                    axis.ticks.y = element_blank()) +
              labs(fill = "State") +
              scale_x_continuous(labels = scales::percent_format())


bxp_time = ggplot(daily_budget_id,
                  aes(x = season,
                      y = time,
                      color = state)) +
            gghalves::geom_half_boxplot(nudge = 0.05,
                                        outlier.color = NA) +
            gghalves::geom_half_point() +
            scale_color_manual(values = tuco_pal) +
            scale_x_discrete(labels = c("Mar","Jul","Oct","Feb")) +
            facet_wrap(~state) +
            xlab("") +
            ylab("Mean daily\ntime in state (min)") +
            theme(legend.position = "none")

df1 = data.frame(x = c(1.9, 3), 
                 y = c(750, 750), 
                 state = factor("Medium", "Medium"))
df2 = data.frame(x = c(1.9, 3), 
                 y = c(750, 750), 
                 state = factor("High", "High"))
df3 = data.frame(x = c(1.9, 4), 
                 y = c(800, 800), 
                 state = factor("High", "High"))

bxp_time = bxp_time +
   geom_line(data = df1,
             mapping = aes(x,y, group = 1),
             color = "grey60") +
   geom_line(data = df2,
             mapping = aes(x,y, group = 1),
             color = "grey60") +
   geom_line(data = df3,
             mapping = aes(x,y, group = 1),
             color = "grey60") +
  geom_text(data = data.frame(x = c(2.5, 2.5, 3),
                       y = c(760,760,820),
                       state = factor(c("Medium", "High", "High"),),
                       label = rep("*",3)),
            aes(x,y,label = label),
            color = "grey60")

bar_time + bxp_time +
  plot_layout(ncol = 1,
              heights = c(2.5,1)) +
  plot_annotation(tag_levels = "A")
```
\newpage

### Aboveground Activity

```{r}
tuco_luximeter = tuco.metadata %>% 
    filter(lux, recaptured, collar_recovered) %>% 
    dplyr::select(ID)

tuco_abv_act = tuco %>% 
    filter(ID %in% tuco_luximeter$ID, daytime == T) %>%
    group_by(ID) %>% 
    mutate(lux_filled = zoo::na.locf(lux, fromLast = T, na.rm = F),
           aboveground = ifelse(lux_filled >= 2, T, F)) %>% 
    ungroup()

aboveground_activity = tuco_abv_act %>%
    group_by(ID, date = lubridate::date(datetime), season) %>% 
    mutate(total_t_aboveground = sum(aboveground, na.rm = T)) %>%
    group_by(ID, date = lubridate::date(datetime), season, state) %>% 
    summarise(time = sum(aboveground, na.rm = T),
              total_t_aboveground = total_t_aboveground,
              perc = time/total_t_aboveground) %>% 
    unique() %>% 
    group_by(ID, season, state) %>% 
    summarise(
        time = mean(time),
        perc = mean(perc, na.rm = T)
    ) %>% 
    ungroup()
```

Outside of their tunnels, when exposed to light, tuco-tucos are mostly in an active state, either high or medium state (Fig. \@ref(fig:aboveground-activity)). There is no significant difference between month-groups within any state (Kruskal-Wallis, p > 0.05). The overall mean surface time spent on the high activity state is `r aboveground_activity %>% filter(state == "High") %>% summarise(mean = round(mean(time), 2)) %>% dplyr::select(mean)` minutes, whether for the medium state the it is `r aboveground_activity %>% filter(state == "Medium") %>% summarise(mean = round(mean(time), 2)) %>% dplyr::select(mean)` minutes. Low activity, in contrast, is the behavioral state that happens the least on the surface with a mean of `r aboveground_activity %>% filter(state == "Low") %>% summarise(mean = round(mean(time), 2)) %>% dplyr::select(mean)` minutes, considering all month-groups together. \newline

```{r aboveground-activity,  fig.asp=0.8, fig.width=9, out.width="100%", fig.pos="H", fig.align='center', fig.cap = "Mean time per animal and individual percentages of behavioral states exhibited on the surface. (A) Percentage of aboveground time spent in each behavioral state per animal in relation to the total time on surface. (B) Mean daily time of behavioral states exhibited aboveground per animal. Asterisks shows statistical significant pairwise comparison between Months. There is no significant difference between month-groups within any state (Kruskal-Wallis, p > 0.05)."}

abvg_bar = ggplot(aboveground_activity, aes(perc, ID, fill = state, group = season)) +
    geom_bar(position = "stack",
             stat = "identity") +
    geom_text(aes(label = round(perc, 3) * 100), 
              position = position_stack(vjust = 0.5), 
              color = "grey98", size = 2.8) +
    scale_fill_manual(values = tuco_pal[1:3]) +
    #scale_x_continuous(expand = c(0.02, 0)) +
    facet_grid(season~.,
               scales = "free",
               space = "free_y") +
    theme(panel.border = element_rect(colour = NA, fill=NA),
          axis.ticks.y = element_blank()) +
    labs(fill = "State") +
    scale_x_continuous(labels = scales::percent_format()) +
    ylab("") +
    xlab("Mean percentage of time on surface")

plot_abvact_time = ggplot(aboveground_activity, aes(season, time, color = state)) +
    gghalves::geom_half_point() +
    gghalves::geom_half_boxplot(nudge = 0.05, outlier.alpha = 0) +
    ylab("Mean daily time in\naboveground activity (min)") +
    xlab("") +
    scale_color_manual(values = tuco_pal[1:3]) +
    theme(legend.position = "none") + 
    facet_wrap(vars(state))

# plot_abvact_perc = ggplot(aboveground_activity, aes(state, perc, color = state)) +
#     gghalves::geom_half_point() +
#     gghalves::geom_half_boxplot(nudge = 0.05, outlier.alpha = 0) +
#     ylab("Percentage of\nAboveground Activity") +
#     xlab("") +
#     scale_color_manual(values = tuco_pal[1:3]) +
#     theme(legend.position = "none") +
#     scale_y_continuous(labels = scales::percent_format())

abvg_bar + plot_abvact_time+
  plot_layout(ncol = 1,
              heights = c(1.8,1)) +
  plot_annotation(tag_levels = "A")
```

\newpage

### Circadian Rhythmicity

```{r read-rhythmicity, message=FALSE, warning=FALSE, include=FALSE}
acf_peaks = readRDS("../03_analysis/rhythmicity/rhythmicity_classified.rds") %>% ungroup()
period_peaks = readRDS("../03_analysis/periodogram/peaks_period.rds") %>% ungroup()

levels(acf_peaks$state) = c("Low", "Medium", "High", "General Activity")
levels(period_peaks$state) = c("Low", "Medium", "High", "General Activity")
```

Circadian rhythms are present in all states as seen in the visual analysis of the autocorrelation plots (REF APPENDIX - plotar ACFs individuais). The percentage of animals classified as rhythmic is higher for the high activity state, where a total of 18 animals were classified as rhythmic (85.7%). In contrast, 11 animals (52.4%) were classified as rhythmic for the medium activity state \@ref(tab:rhymicity-table).

```{r rhymicity-table, dpi=200, fig.width=6, fig.height=3, fig.cap="Percentage of animals classified as rhythmic for a circadian component (~24h). Classification of rhythmic animals was done visually using Autocorrelation plots. Animals that showed a rhythmic autocorrelation plot was classified as rhythmic."}
#  --------------------------------!!
#  TRANSFORMAR EM GRAFICO ---------!!
# ---------------------------------!!
# ---------------------------------!!
acf_summary = acf_peaks %>%
group_by(State = state) %>%
summarise(Animals = length(rhythmic),
         Rhythmic = sum(rhythmic),
         Percentage = round(sum(rhythmic)/length(rhythmic)*100, 1)
         )

kable(acf_summary, caption = "Number and percentage of animals classified as rhythmic.")
```

We calculated the RI only for animals classified as rhythmic (Figure \@ref(fig:plot-ri-and-period)A), which is why there is a different number of samples between each category. Nonetheless, the Medium Activity State is significantly different from the other states and VeDBA (Figure \@ref(fig:plot-ri-and-period)A; Kruskal-Wallis; p \< 0.05). We did not test for differences between seasons (See Methods).

We used Lomb-Scargle periodograms to estimate the periodicity of each state (Figure \@ref(fig:plot-ri-and-period)B). All estimated periods, independent of state, were in the 24-hour range. We also estimated RI and periodicity for unlabelled VeDBA. In comparison with state-labelled data VeDBA analysis are more similar to the high activity state. The number of animals classified as rhythmic based on the autocorrelation plot is similar between VeDBA and high activity state data. The distribution of RI shows no difference between High state and VeDBA (Figure \@ref(fig:plot-ri-and-period) A).

```{r plot-ri-and-period, fig.width=9, fig.height=3, fig.pos = "H", out.width="100%", fig.align='center', fig.cap = "Rhythmicity metrics for estimated behavioral estates and unlabelled VeDBA. (A) Rhythmicity Index calculated per animal for state-labelled data and VeDBA. The distribution of the Medium State is statistically different from all other states and VeDBA (Kruskal-Wallis, p > 0.05). (B) Period estimation for behavioral states and VeDBA. "}
acf_dist_plot = ggplot(acf_peaks %>% filter(rhythmic == T),
                       aes(x = state,
                           y = acf,
                           color = state)) +
    gghalves::geom_half_boxplot() +
    gghalves::geom_half_point(transformation = position_jitter(width = 0.05, height = 0)) +
    scale_y_continuous(n.breaks = 8) +
    ylab("Rhythmicity Index (RI)") +
    xlab("") +
    scale_color_manual(values = tuco_pal) +
    geom_text(data = data.frame(state = "Medium", acf = 0.3), aes(state, acf), label = "*", color = "grey60", size = 5) +
    theme(legend.position = "none")

period_dist_plot = ggplot(period_peaks %>% filter(rhythmic == T)) +
    geom_histogram(aes(x = peak/60,
                      fill = state), 
                      alpha = 0.3,
                      bins = 14,
                   position = "identity") +
    scale_y_continuous(n.breaks = 10) +
    scale_x_continuous(breaks = seq(21,27), limits = c(21,27)) +
    xlab("Period") +
    ylab("Count") +
    scale_color_manual(values = tuco_pal) +
    scale_fill_manual(values = tuco_pal)

acf_dist_plot + period_dist_plot + patchwork::plot_annotation(tag_levels = "A") + patchwork::plot_layout(widths = c(2,1))
```

\newpage

## Discussion

In the present study, we aimed to establish a field methodology that could be used in tuco-tuco's biologging studies and describe annual changes in activity rhythms. Regarding the field methodology, biologging studies in Anillaco's tuco-tucos is feasible and bears good recapture rates. We were able to successfully recover 70% of the deployed sensors using capture-recapture with radio telemetry assistance. Regarding our second aim of describing the daily activity patterns in tuco-tucos, the biologging studies showed that tuco-tucos are diurnal, allocating the bulk of their movement during the daytime, with an annual reduction of daily activity in July. Surface emergence, on the other hand, had a clear difference in patterns along the year in parallel with an increase in the surface time in relation to day length in July. Using HMMs we also classified the acceleration data and found that the high intensity behavioral state has a stronger diurnal aspect than the medium and low intensity. Furthermore, the allocation of time in different behavioral states seems to change annually. In July tuco-tucos decreased their time in high intensity activity which was replaced by the medium intensity behavioral state. Considered together, these results show that free-living tuco-tucos are diurnal and display an annual change in total activity, surface time and behavior allocation.

